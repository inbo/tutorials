<!DOCTYPE html>
<html lang='en' dir='auto'><head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='Handling large text files in R'>
<meta name='theme-color' content='#c04384'>

<meta property='og:title' content='Reading large data files in R • Bart Aelterman'>
<meta property='og:description' content='Handling large text files in R'>
<meta property='og:url' content='/tutorials/r_large_data_files_handling/'>
<meta property='og:site_name' content='INBO Tutorials'>
<meta property='og:type' content='article'><meta property='article:section' content='tutorials'><meta property='article:tag' content='tidyverse'><meta property='article:tag' content='r'><meta property='article:tag' content='database'><meta property='article:published_time' content='2017-02-10T00:00:00Z'/><meta property='article:modified_time' content='2017-02-10T00:00:00Z'/><meta name='twitter:card' content='summary'>

<meta name="generator" content="Hugo 0.88.1" />

  <title>Reading large data files in R • Bart Aelterman</title>
  <link rel='canonical' href='/tutorials/r_large_data_files_handling/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.ab98e12b.css'><link rel='stylesheet' href='/css/custom.css'><style>
:root{--color-accent:#c04384;}
</style>

  

</head>
<body class='page type-tutorials has-sidebar'>

  <div class='site'><div id='sidebar' class='sidebar'>
  <a class='screen-reader-text' href='#main-menu'>Skip to Main Menu</a>

  <div class='container'><section class='widget widget-about sep-after'>
  <header>
    
    <div class='logo'>
      <a href='/'>
        <img src='/images/logo.png'>
      </a>
    </div>
    
    <h2 class='title site-title '>
      <a href='/'>
       
      </a>
    </h2>
    <div class='desc'>
    
    </div>
  </header>

</section>
<section class='widget widget-search sep-after'>
  <header>
    <h4 class='title widget-title'> </h4>
  </header>

  <form action='/search' id='search-form' class='search-form'>
    <label>
      <span class='screen-reader-text'>Search</span>
      <input id='search-term' class='search-term' type='search' name='q' placeholder='Search&hellip;'>
    </label></form>

</section>
<section class='widget widget-sidebar_menu sep-after'><nav id='sidebar-menu' class='menu sidebar-menu' aria-label='Sidebar Menu'>
    <div class='container'>
      <ul><li class='item'>
  <a href='/'>Home</a></li><li class='item'>
  <a href='/articles/'>Articles</a></li><li class='item has-current'>
  <a href='/tutorials/'>Tutorials</a></li><li class='item'>
  <a href='/create_tutorial/'>Create tutorial</a></li><li class='item has-children'>
  <a href='/installation/'>Installation</a><button class='sub-menu-toggler'>
    <span class='screen-reader-text'>expand sub menu</span>
    <span class='sign'></span>
  </button>

  <ul class='sub-menu'><li class='item'>
  <a href='/installation/administrator/'>For admins</a></li><li class='item'>
  <a href='/installation/user/'>For users</a></li></ul></li><li class='item'>
  <a href='/categories/'>Categories</a></li><li class='item'>
  <a href='https://github.com/inbo/tutorials'>Repository</a></li></ul>
    </div>
  </nav>

</section><section class='widget widget-taxonomy_cloud sep-after'>
  <header>
    <h4 class='title widget-title'>Tags</h4>
  </header>

  <div class='container list-container'>
  <ul class='list taxonomy-cloud no-shuffle'><li>
        <a href='/tags/analysis/' style='font-size:1.0512820512820513em'>analysis</a>
      </li><li>
        <a href='/tags/analysis-of-variance/' style='font-size:1em'>analysis of variance</a>
      </li><li>
        <a href='/tags/api/' style='font-size:1.0128205128205128em'>api</a>
      </li><li>
        <a href='/tags/bibliography/' style='font-size:1.0128205128205128em'>bibliography</a>
      </li><li>
        <a href='/tags/biodiversity/' style='font-size:1.0128205128205128em'>biodiversity</a>
      </li><li>
        <a href='/tags/biorad/' style='font-size:1em'>bioRad</a>
      </li><li>
        <a href='/tags/bookdown/' style='font-size:1.0128205128205128em'>bookdown</a>
      </li><li>
        <a href='/tags/brms/' style='font-size:1em'>brms</a>
      </li><li>
        <a href='/tags/checklist/' style='font-size:1.0256410256410255em'>checklist</a>
      </li><li>
        <a href='/tags/ci/' style='font-size:1.0128205128205128em'>ci</a>
      </li><li>
        <a href='/tags/coding-club/' style='font-size:1em'>coding club</a>
      </li><li>
        <a href='/tags/csl/' style='font-size:1.0128205128205128em'>csl</a>
      </li><li>
        <a href='/tags/data/' style='font-size:1.0256410256410255em'>data</a>
      </li><li>
        <a href='/tags/database/' style='font-size:1.0512820512820513em'>database</a>
      </li><li>
        <a href='/tags/development/' style='font-size:1.0128205128205128em'>development</a>
      </li><li>
        <a href='/tags/dplyr/' style='font-size:1em'>dplyr</a>
      </li><li>
        <a href='/tags/e-book/' style='font-size:1em'>e-book</a>
      </li><li>
        <a href='/tags/effectclass/' style='font-size:1.0256410256410255em'>effectclass</a>
      </li><li>
        <a href='/tags/endnote/' style='font-size:1em'>endnote</a>
      </li><li>
        <a href='/tags/etn/' style='font-size:1em'>etn</a>
      </li><li>
        <a href='/tags/explorative-data-analysis/' style='font-size:1em'>explorative data analysis</a>
      </li><li>
        <a href='/tags/frictionless/' style='font-size:1em'>frictionless</a>
      </li><li>
        <a href='/tags/gbif/' style='font-size:1.0128205128205128em'>gbif</a>
      </li><li>
        <a href='/tags/generalized-linear-regression/' style='font-size:1.0128205128205128em'>generalized linear regression</a>
      </li><li>
        <a href='/tags/ggplot2/' style='font-size:1.0128205128205128em'>ggplot2</a>
      </li><li>
        <a href='/tags/gis/' style='font-size:1.1282051282051282em'>gis</a>
      </li><li>
        <a href='/tags/git/' style='font-size:1.1282051282051282em'>git</a>
      </li><li>
        <a href='/tags/gitbook/' style='font-size:1.0128205128205128em'>gitbook</a>
      </li><li>
        <a href='/tags/github/' style='font-size:1.0384615384615385em'>github</a>
      </li><li>
        <a href='/tags/google/' style='font-size:1.0128205128205128em'>google</a>
      </li><li>
        <a href='/tags/grids/' style='font-size:1em'>grids</a>
      </li><li>
        <a href='/tags/gwlogger/' style='font-size:1.0384615384615385em'>gwloggeR</a>
      </li><li>
        <a href='/tags/inbodb/' style='font-size:1.0256410256410255em'>inbodb</a>
      </li><li>
        <a href='/tags/inbomd/' style='font-size:1.0384615384615385em'>INBOmd</a>
      </li><li>
        <a href='/tags/inborutils/' style='font-size:1.0384615384615385em'>inborutils</a>
      </li><li>
        <a href='/tags/inla/' style='font-size:1.0256410256410255em'>INLA</a>
      </li><li>
        <a href='/tags/inlabru/' style='font-size:1em'>inlabru</a>
      </li><li>
        <a href='/tags/inlatools/' style='font-size:1.0256410256410255em'>inlatools</a>
      </li><li>
        <a href='/tags/installation/' style='font-size:1.1153846153846154em'>installation</a>
      </li><li>
        <a href='/tags/literature/' style='font-size:1.0512820512820513em'>literature</a>
      </li><li>
        <a href='/tags/maps/' style='font-size:1.0769230769230769em'>maps</a>
      </li><li>
        <a href='/tags/markdown/' style='font-size:1.0256410256410255em'>markdown</a>
      </li><li>
        <a href='/tags/mendeley/' style='font-size:1em'>mendeley</a>
      </li><li>
        <a href='/tags/mgrs/' style='font-size:1em'>mgrs</a>
      </li><li>
        <a href='/tags/mixed-model/' style='font-size:1.064102564102564em'>mixed model</a>
      </li><li>
        <a href='/tags/mixed-models/' style='font-size:1em'>mixed models</a>
      </li><li>
        <a href='/tags/multivariate-statistics/' style='font-size:1em'>multivariate statistics</a>
      </li><li>
        <a href='/tags/n2khab/' style='font-size:1.0512820512820513em'>n2khab</a>
      </li><li>
        <a href='/tags/open-science/' style='font-size:1.0897435897435896em'>open science</a>
      </li><li>
        <a href='/tags/packages/' style='font-size:1.0384615384615385em'>packages</a>
      </li><li>
        <a href='/tags/pandoc/' style='font-size:1.0128205128205128em'>pandoc</a>
      </li><li>
        <a href='/tags/python/' style='font-size:1em'>python</a>
      </li><li>
        <a href='/tags/r/' style='font-size:2em'>r</a>
      </li><li>
        <a href='/tags/renv/' style='font-size:1em'>renv</a>
      </li><li>
        <a href='/tags/reports/' style='font-size:1.0128205128205128em'>reports</a>
      </li><li>
        <a href='/tags/rgbif/' style='font-size:1.064102564102564em'>rgbif</a>
      </li><li>
        <a href='/tags/rmarkdown/' style='font-size:1.0256410256410255em'>rmarkdown</a>
      </li><li>
        <a href='/tags/rstudio/' style='font-size:1.0512820512820513em'>rstudio</a>
      </li><li>
        <a href='/tags/spreadsheet/' style='font-size:1em'>spreadsheet</a>
      </li><li>
        <a href='/tags/sql/' style='font-size:1em'>SQL</a>
      </li><li>
        <a href='/tags/stan/' style='font-size:1em'>stan</a>
      </li><li>
        <a href='/tags/styleguide/' style='font-size:1.0384615384615385em'>styleguide</a>
      </li><li>
        <a href='/tags/tidyverse/' style='font-size:1.0384615384615385em'>tidyverse</a>
      </li><li>
        <a href='/tags/uncertainty/' style='font-size:1.0128205128205128em'>uncertainty</a>
      </li><li>
        <a href='/tags/utm/' style='font-size:1em'>utm</a>
      </li><li>
        <a href='/tags/version-control/' style='font-size:1.1025641025641026em'>version control</a>
      </li><li>
        <a href='/tags/vignette/' style='font-size:1.4871794871794872em'>vignette</a>
      </li><li>
        <a href='/tags/visual-markdown-editing/' style='font-size:1em'>visual markdown editing</a>
      </li><li>
        <a href='/tags/vmm/' style='font-size:1em'>vmm</a>
      </li><li>
        <a href='/tags/waterinfo/' style='font-size:1.0256410256410255em'>wateRinfo</a>
      </li><li>
        <a href='/tags/watina/' style='font-size:1.0256410256410255em'>watina</a>
      </li><li>
        <a href='/tags/webservice/' style='font-size:1.0384615384615385em'>webservice</a>
      </li><li>
        <a href='/tags/windows/' style='font-size:1em'>windows</a>
      </li><li>
        <a href='/tags/zenodo/' style='font-size:1em'>zenodo</a>
      </li><li>
        <a href='/tags/zotero/' style='font-size:1.0128205128205128em'>zotero</a>
      </li></ul>
</div>


</section>
<section class='widget widget-social_menu sep-after'><nav aria-label='Social Menu'>
    <ul><li>
        <a href='https://github.com/inbo' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Github account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
  
</svg>
</a>
      </li><li>
        <a href='https://twitter.com/INBOVlaanderen' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Twitter account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
  
</svg>
</a>
      </li><li>
        <a href='https://facebook.com/INBOVlaanderen' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Facebook account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/>
  
</svg>
</a>
      </li></ul>
  </nav>
</section>
<section class='widget widget-build_time sep-after'>
  <p><small>Built on: Fri Feb 21 08:32:05 UTC 2025</small></p>
</section></div>

  <div class='sidebar-overlay'></div>
</div><div class='main'><a class='screen-reader-text' href='#content'>Skip to Content</a>

<button id='sidebar-toggler' class='sidebar-toggler' aria-controls='sidebar'>
  <span class='screen-reader-text'>Toggle Sidebar</span>
  <span class='open'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="3" y1="12" x2="21" y2="12" />
  <line x1="3" y1="6" x2="21" y2="6" />
  <line x1="3" y1="18" x2="21" y2="18" />
  
</svg>
</span>
  <span class='close'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="18" y1="6" x2="6" y2="18" />
  <line x1="6" y1="6" x2="18" y2="18" />
  
</svg>
</span>
</button><div class='header-widgets'>
        <div class='container'>
    
    <style>.widget-breadcrumbs li:after{content:'\2f '}</style>
  <section class='widget widget-breadcrumbs sep-after'>
    <nav id='breadcrumbs'>
      <ol><li><a href='/'>Home</a></li><li><a href='/tutorials/'>Tutorials</a></li><li><span>Reading large data files in R</span></li></ol>
    </nav>
  </section></div>
      </div>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>INBO Tutorials</p><p class='desc site-desc'></p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='en' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>Reading large data files in R</h1>
      
<p class='desc'>Handling large text files in R</p>


    </div>
    <div class='entry-meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader-text'>Posted on </span>
  <time class='entry-date' datetime='2017-02-10T00:00:00Z'>2017, Feb 10</time>
</span>

  <span class='byline'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M21,21V20c0-2.76-4-5-9-5s-9,2.24-9,5v1"/>
  <path d="M16,6.37A4,4,0,1,1,12.63,3,4,4,0,0,1,16,6.37Z"/>
  
</svg>
<span class='screen-reader-text'> by </span><a href='/authors/bartaelterman'>Bart Aelterman</a>, <a href='/authors/stijnvanhoey'>Stijn Van Hoey</a></span>
  <br/>
  
<span class='reading-time'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/>
  
</svg>
14 mins read
</span>


  <span class="github-link">

    

        

        
            
        

        
            <a href='https://github.com/inbo/tutorials/edit/master/content/tutorials/r_large_data_files_handling/index.Rmd'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
  
</svg>
Improve this page</a>
        

        
    
</span>

</div>


  </div>
</header>

  
  

  <div class='container entry-content'><h2 id="intro">Intro<a href="#intro" class="anchor"><svg height="22px" viewBox="0 0 24 24" width="22px"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a></h2>
<p>R is known to have difficulties handling large data files. Here we will
explore some tips that make working with such files in R less painfull.</p>
<h2 id="tldr">tl;dr<a href="#tldr" class="anchor"><svg height="22px" viewBox="0 0 24 24" width="22px"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a></h2>
<ul>
<li>If you can comfortably work with the entire file in memory, but
reading the file is rather slow, consider using the <code>data.table</code>
package and <a href="#loadentire">read the file with its <code>fread</code> function</a>.</li>
<li>If your file does not comfortably fit in memory:
<ul>
<li><a href="#sqldftit">Use <code>sqldf</code></a> if you have to stick to <code>csv</code> files.</li>
<li>Use a SQLite database and query it using either <a href="#sqlitestrat">SQL
queries</a> or <a href="#dplyrstrat"><code>dplyr</code></a>.</li>
<li><a href="#convertsqlite">Convert</a> your <code>csv</code> file to a <code>sqlite</code> database
in order to query</li>
</ul>
</li>
</ul>
<h2 id="downloading-the-example-files">Downloading the example files<a href="#downloading-the-example-files" class="anchor"><svg height="22px" viewBox="0 0 24 24" width="22px"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a></h2>
<p>While you can directly test this tutorial on your own large data files,
we will use bird tracking data from the <a href="https://doi.org/10.3897/zookeys.555.6173">LifeWatch bird tracking
network</a> for the examples. We
have made two versions of some tracking data available for download: a
<code>.csv</code> file (text data) and a <code>.db</code> file (sqlite data). Both contain
processed log files; for more information on the processing, see the
<a href="https://github.com/inbo/bird-tracking-etl">BirdTrackingEtl package</a>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">csv.name &lt;- <span style="color:#a50">&#34;2016-04-20-processed-logs-big-file-example.csv&#34;</span>
db.name &lt;- <span style="color:#a50">&#34;2016-04-20-processed-logs-big-file-example.db&#34;</span>
</code></pre></div><p>The evaluation of the next code chunk is ignored by default as the
downloading and unzipping of the files results in more than 3 GB of
data. If you do want to download the files yourself and test the other
chunks, run the code and download the <code>csv</code> and <code>sqlite</code> examples. Make
sure you have the <code>R.utils</code> package available (for unzipping the
downloaded files). If not, use the command <code>install.packages(&quot;R.utils&quot;)</code>
in your R console to download the package.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#0a0">library</span>(<span style="color:#a50">&#34;R.utils&#34;</span>)
<span style="color:#aaa;font-style:italic"># download the CSV file example</span>
csv.url &lt;- <span style="color:#0a0">paste</span>(<span style="color:#a50">&#34;https://s3-eu-west-1.amazonaws.com/lw-birdtracking-data/&#34;</span>, 
                 csv.name, <span style="color:#a50">&#34;.gz&#34;</span>, sep = <span style="color:#a50">&#34;&#34;</span>)
<span style="color:#0a0">if </span>(!<span style="color:#0a0">file.exists</span>(csv.name)) {
    <span style="color:#0a0">download.file</span>(csv.url, destfile = <span style="color:#0a0">paste0</span>(csv.name, <span style="color:#a50">&#34;.gz&#34;</span>))
    <span style="color:#0a0">gunzip</span>(<span style="color:#0a0">paste0</span>(csv.name, <span style="color:#a50">&#34;.gz&#34;</span>))
}

<span style="color:#aaa;font-style:italic"># download the sqlite database example</span>
db.url &lt;- <span style="color:#0a0">paste</span>(<span style="color:#a50">&#34;https://s3-eu-west-1.amazonaws.com/lw-birdtracking-data/&#34;</span>, 
                db.name, <span style="color:#a50">&#34;.gz&#34;</span>, sep = <span style="color:#a50">&#34;&#34;</span>)
<span style="color:#0a0">if </span>(!<span style="color:#0a0">file.exists</span>(db.name)) {
    <span style="color:#0a0">download.file</span>(db.url, destfile = <span style="color:#0a0">paste0</span>(db.name, <span style="color:#a50">&#34;.gz&#34;</span>))
    <span style="color:#0a0">gunzip</span>(<span style="color:#0a0">paste0</span>(db.name, <span style="color:#a50">&#34;.gz&#34;</span>))
}
</code></pre></div><h2 id="loading-a-large-dataset-use-fread-or-functions-from-readr-instead-of-readxxx">Loading a large dataset: use <code>fread()</code> or functions from <code>readr</code> instead of <code>read.xxx()</code>.<a href="#loading-a-large-dataset-use-fread-or-functions-from-readr-instead-of-readxxx" class="anchor"><svg height="22px" viewBox="0 0 24 24" width="22px"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a></h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#0a0">library</span>(<span style="color:#a50">&#34;data.table&#34;</span>)
<span style="color:#0a0">library</span>(<span style="color:#a50">&#34;readr&#34;</span>)
</code></pre></div><p>If you really need to read an entire csv in memory, by default, R users
use the <code>read.table</code> method or variations thereof (such as <code>read.csv</code>).
However, <code>fread</code> from the <code>data.table</code> package is a lot faster.
Furthermore, the <code>readr</code> package also provides more optimized reading
functions (<code>read_csv</code>, <code>read_delim</code>,…). Let’s measure the time to read
in the data using these three different methods.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">read.table.timing &lt;- <span style="color:#0a0">system.time</span>(<span style="color:#0a0">read.table</span>(csv.name, header = <span style="color:#00a">TRUE</span>, sep = <span style="color:#a50">&#34;,&#34;</span>))
readr.timing &lt;- <span style="color:#0a0">system.time</span>(<span style="color:#0a0">read_delim</span>(csv.name, <span style="color:#a50">&#34;,&#34;</span>, col_names = <span style="color:#00a">TRUE</span>))
data.table.timing &lt;- <span style="color:#0a0">system.time</span>(allData &lt;- <span style="color:#0a0">fread</span>(csv.name, showProgress = <span style="color:#00a">FALSE</span>))
data &lt;- <span style="color:#0a0">data.frame</span>(method = <span style="color:#0a0">c</span>(<span style="color:#a50">&#39;read.table&#39;</span>, <span style="color:#a50">&#39;readr&#39;</span>, <span style="color:#a50">&#39;fread&#39;</span>), 
                  timing = <span style="color:#0a0">c</span>(read.table.timing[3], readr.timing[3], data.table.timing[3]))
data
</code></pre></div><pre><code>##       method  timing
## 1 read.table 183.732
## 2      readr   3.625
## 3      fread  12.564
</code></pre>
<p><code>fread</code> and <code>read_delim</code> are indeed much faster then the default
<code>read.table</code>. However, the result of <code>fread</code> is a <code>data.table</code> and the
result of <code>read_delim</code> is a <code>tibble</code>. Both are not a <code>data.frame</code>. The
<code>data.table</code> package describes the <code>data.table</code> object as a more
performant replacement for the <code>data.frame</code>. This means that selecting,
filtering and aggregating data is much faster on a <code>data.table</code> compared
to the standard <code>data.frame</code> but it requires you to use a slightly
different syntax. A <code>tibble</code> is very similar to a <code>data.frame</code>, but
provides more convenience when printing or subsetting the data table.</p>
<p>You can find the <code>data.table</code> package on
<a href="https://cran.r-project.org/web/packages/data.table/index.html">CRAN</a>. A
good place to learn this package are the package vignettes. The
<a href="https://cran.r-project.org/web/packages/data.table/vignettes/datatable-intro-vignette.html">introduction to
data.table</a>
should be enough to get started. The <code>readr</code> package is also on
<a href="https://cran.r-project.org/web/packages/readr/index.html">CRAN</a>. It
belongs to a suite of R packages aiming to improve data manipulation in
R, called <a href="http://tidyverse.org/">tidyverse</a>. More examples and
explanation about <code>readr</code> is provided on the <a href="http://readr.tidyverse.org/">readr
website</a>.</p>
<h2 id="data-files-that-dont-fit-in-memory">Data files that don’t fit in memory<a href="#data-files-that-dont-fit-in-memory" class="anchor"><svg height="22px" viewBox="0 0 24 24" width="22px"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a></h2>
<p>If you are not able to read in the data file, because it does not fit in
memory (or because R becomes too slow when you load the entire dataset),
you will need to limit the amount of data that will actually be stored
in memory. There are a couple of options which we will investigate:</p>
<ol>
<li>limit the number of lines you are trying to read for some
exploratory analysis. Once you are happy with the analysis you want
to run on the entire dataset, move to another machine.</li>
<li>limit the number of columns you are reading to reduce the memory
required to store the data.</li>
<li>limit both the number of rows and the number of columns using
<code>sqldf</code>.</li>
<li>stream the data.</li>
</ol>
<h3 id="1-limit-the-number-of-lines-you-read-fread">1. Limit the number of lines you read (<code>fread</code>)<a href="#1-limit-the-number-of-lines-you-read-fread" class="anchor"><svg height="22px" viewBox="0 0 24 24" width="22px"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a></h3>
<p>Limiting the number of lines you read is easy. Just use the <code>nrows</code>
and/or <code>skip</code> option (available to both <code>read.table</code> and <code>fread</code>).
<code>skip</code> can be used to skip a number of rows, but you can also pass a
string to this parameter causing <code>fread</code> to only start reading lines
from the first line matching that string. Let’s say we only want to
start reading lines after we find a line matching the pattern
<code>2015-06-12 15:14:39</code>. We can do that like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#0a0">sprintf</span>(<span style="color:#a50">&#34;Number of lines in full data set: %s&#34;</span>, <span style="color:#0a0">nrow</span>(allData))
</code></pre></div><pre><code>## [1] &quot;Number of lines in full data set: 3761058&quot;
</code></pre>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">subSet &lt;- <span style="color:#0a0">fread</span>(csv.name, skip = <span style="color:#a50">&#34;2015-06-12 15:14:39&#34;</span>, showProgress = <span style="color:#00a">FALSE</span>)
<span style="color:#0a0">sprintf</span>(<span style="color:#a50">&#34;Number of lines in data set with skipped lines: %s&#34;</span>, <span style="color:#0a0">nrow</span>(subSet))
</code></pre></div><pre><code>## [1] &quot;Number of lines in data set with skipped lines: 9998&quot;
</code></pre>
<p>Skipping rows this way is obviously not giving you the entire dataset,
so this strategy is only useful for doing exploratory analysis on a
subset of your data. Note that also <code>read_delim</code> provides a <code>n_max</code>
argument to limit the number of lines to read. If you want to explore
the whole dataset, limiting the number of columns you read can be a more
useful strategy.</p>
<h3 id="2-limit-the-number-of-columns-you-read-fread">2. Limit the number of columns you read (<code>fread</code>)<a href="#2-limit-the-number-of-columns-you-read-fread" class="anchor"><svg height="22px" viewBox="0 0 24 24" width="22px"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a></h3>
<p>If you only need 4 columns of the 21 columns present in the file, you
can tell <code>fread</code> to only select those 4. This can have a major impact on
the memory footprint of your data. The option you need for this is:
<code>select</code>. With this, you can specify a number of columns to keep. The
opposite - specifying the columns you want to drop - can be accomplished
with the <code>drop</code> option.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">fourColumns = <span style="color:#0a0">fread</span>(csv.name, select = <span style="color:#0a0">c</span>(<span style="color:#a50">&#34;device_info_serial&#34;</span>, <span style="color:#a50">&#34;date_time&#34;</span>, 
                                         <span style="color:#a50">&#34;latitude&#34;</span>, <span style="color:#a50">&#34;longitude&#34;</span>), 
                    showProgress = <span style="color:#00a">FALSE</span>)
<span style="color:#0a0">sprintf</span>(<span style="color:#a50">&#34;Size of total data in memory: %s MB&#34;</span>, utils::<span style="color:#0a0">object.size</span>(allData)/<span style="color:#099">1000000</span>)
</code></pre></div><pre><code>## [1] &quot;Size of total data in memory: 1173.480728 MB&quot;
</code></pre>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#0a0">sprintf</span>(<span style="color:#a50">&#34;Size of only four columns in memory: %s MB&#34;</span>, utils::<span style="color:#0a0">object.size</span>(fourColumns)/<span style="color:#099">1000000</span>)
</code></pre></div><pre><code>## [1] &quot;Size of only four columns in memory: 105.311936 MB&quot;
</code></pre>
<p>The difference might not be as large as you would expect. R objects
claim more memory than needed to store the data alone, as they keep
pointers, and other object attributes. But still, the difference could
save you.</p>
<h3 id="3-limiting-both-the-number-of-rows-and-the-number-of-columns-using-sqldf">3. Limiting both the number of rows and the number of columns using <code>sqldf</code><a href="#3-limiting-both-the-number-of-rows-and-the-number-of-columns-using-sqldf" class="anchor"><svg height="22px" viewBox="0 0 24 24" width="22px"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a></h3>
<p>The <a href="https://cran.r-project.org/web/packages/sqldf/sqldf.pdf">sqldf
package</a> allows
you to run SQL-like queries on a file, resulting in only a selection of
the file being read. It allows you to limit both the number of lines and
the number of rows at the same time. In the background, this actually
creates a sqlite database on the fly to execute the query. Consider
using the package when starting from a csv file, but the actual strategy
boils down to making a sqlite database file of your data. See <a href="#the-database-file-strategy">this
section below</a> to learn how to interact
with those and create a SQlite database from a CSV-file.</p>
<h3 id="4-streaming-data">4. Streaming data<a href="#4-streaming-data" class="anchor"><svg height="22px" viewBox="0 0 24 24" width="22px"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a></h3>
<p><strong>Short:</strong> streaming a file in R is a bad idea. If you are interested
why, read the rest of this section.</p>
<p>Streaming a file means reading it line by line and only keeping the
lines you need or do stuff with the lines while you read through the
file. It turns out that R is really not very efficient in streaming
files. The main reason is the memory allocation process that has
difficulties with a constantly growing object (which can be a dataframe
containing only the selected lines).</p>
<p>In the next code block, we will read parts of our data file once using
the <code>fread</code>function, and once line by line. You’ll see the performance
issue with the streaming solution.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#0a0">library</span>(ggplot2)
allowedDevices = <span style="color:#0a0">c</span>(<span style="color:#099">753</span>, <span style="color:#099">801</span>, <span style="color:#099">852</span>)
minDate = <span style="color:#0a0">strptime</span>(<span style="color:#a50">&#39;1/3/2014&#39;</span>,format = <span style="color:#a50">&#39;%d/%m/%Y&#39;</span>)
maxDate = <span style="color:#0a0">strptime</span>(<span style="color:#a50">&#39;1/10/2014&#39;</span>,format = <span style="color:#a50">&#39;%d/%m/%Y&#39;</span>)

streamFile &lt;- <span style="color:#0a0">function</span>(limit) {
    con &lt;- <span style="color:#0a0">file</span>(csv.name, open = <span style="color:#a50">&#34;r&#34;</span>)
    selectedRecords &lt;- <span style="color:#0a0">list</span>()
    i &lt;- <span style="color:#099">0</span>
    file.streaming.timing &lt;- <span style="color:#0a0">system.time</span>(
        <span style="color:#0a0">while </span>(i &lt; limit) {
            oneLine &lt;- <span style="color:#0a0">readLines</span>(con, n = <span style="color:#099">1</span>, warn = <span style="color:#00a">FALSE</span>)
            vec = (<span style="color:#0a0">strsplit</span>(oneLine, <span style="color:#a50">&#34;,&#34;</span>))
            selectedRecords &lt;- <span style="color:#0a0">c</span>(selectedRecords, vec)
            i &lt;- i + <span style="color:#099">1</span>
        }
    )
    <span style="color:#0a0">close</span>(con)
    <span style="color:#0a0">return</span>(file.streaming.timing[[3]])
}

freadFile &lt;- <span style="color:#0a0">function</span>(limit) {
    file.fread.timing = <span style="color:#0a0">system.time</span>(
        d &lt;- <span style="color:#0a0">fread</span>(csv.name, showProgress = <span style="color:#00a">FALSE</span>, nrows = limit)
    )
    <span style="color:#0a0">return</span>(file.fread.timing[[3]])
}

maxLines &lt;- <span style="color:#0a0">c</span>(<span style="color:#099">5000</span>, <span style="color:#099">10000</span>, <span style="color:#099">15000</span>, <span style="color:#099">20000</span>, <span style="color:#099">25000</span>, <span style="color:#099">30000</span>)
streamingTimes &lt;- <span style="color:#0a0">sapply</span>(maxLines, streamFile)
freadTimes &lt;- <span style="color:#0a0">sapply</span>(maxLines, freadFile)
data &lt;- <span style="color:#0a0">data.frame</span>(n = maxLines, streaming = streamingTimes, 
                   fread = freadTimes)
pdata &lt;- <span style="color:#0a0">melt</span>(data, id = <span style="color:#0a0">c</span>(<span style="color:#a50">&#34;n&#34;</span>))
<span style="color:#0a0">colnames</span>(pdata) &lt;- <span style="color:#0a0">c</span>(<span style="color:#a50">&#34;n&#34;</span>, <span style="color:#a50">&#34;algorithm&#34;</span>, <span style="color:#a50">&#34;execTime&#34;</span>)
<span style="color:#0a0">qplot</span>(n, execTime, data = pdata, color = algorithm, 
      xlab = <span style="color:#a50">&#34;number of lines read&#34;</span>, ylab = <span style="color:#a50">&#34;execution time (s)&#34;</span>)
</code></pre></div><p><img src="index_files/figure-gfm/streamexample-1.png" alt=""><!-- --></p>
<h2 id="the-database-file-strategy">The database file strategy<a href="#the-database-file-strategy" class="anchor"><svg height="22px" viewBox="0 0 24 24" width="22px"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a></h2>
<h3 id="working-with-sqlite-databases">Working with SQLite databases<a href="#working-with-sqlite-databases" class="anchor"><svg height="22px" viewBox="0 0 24 24" width="22px"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a></h3>
<p>SQLite databases are single file databases meaning you can simply
download them, store them in a folder or share them with colleagues.
Similar to a csv. They are however more powerful than csv’s because of
two important features:</p>
<ul>
<li>Support for SQL: this allows you to execute intelligent filters on
your data, similar to the <code>sqldf</code> package or database environments
you are familiar with. That way, you can reduce the amount of data
that’s stored in memory by filtering out rows or columns.</li>
<li>Indexes: SQLite databases contain indexes. An index is something
like an ordered version of a column. When enabled on a column, you
can search through the column much faster. We will demonstrate this
below.</li>
</ul>
<p>We have downloaded a second file
<code>2016-04-20-processed-logs-big-file-example.db</code> that contains the same
data as the <code>2016-04-20-processed-logs-big-file-example.csv</code> file, but
as a sqlite database. Furthermore, the database file contains indexes
which will dramatically drop the time needed to perform search queries.
If you do not have a SQLite database containing your data, you can first
convert your csv into a SQlite as described <a href="#create-a-sqlite-database-from-a-csv-file">further in this
tutorial</a>.</p>
<p>Let’s first connect to the database and list the available tables.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#0a0">library</span>(RSQLite)
db &lt;- <span style="color:#0a0">dbConnect</span>(<span style="color:#0a0">SQLite</span>(), dbname = db.name)

<span style="color:#aaa;font-style:italic"># show the tables in this database</span>
<span style="color:#0a0">dbListTables</span>(db)
</code></pre></div><pre><code>##  [1] &quot;SpatialIndex&quot;                       &quot;geom_cols_ref_sys&quot;                 
##  [3] &quot;geometry_columns&quot;                   &quot;geometry_columns_auth&quot;             
##  [5] &quot;geometry_columns_field_infos&quot;       &quot;geometry_columns_statistics&quot;       
##  [7] &quot;geometry_columns_time&quot;              &quot;processed_logs&quot;                    
##  [9] &quot;spatial_ref_sys&quot;                    &quot;spatialite_history&quot;                
## [11] &quot;sql_statements_log&quot;                 &quot;sqlite_sequence&quot;                   
## [13] &quot;vector_layers&quot;                      &quot;vector_layers_auth&quot;                
## [15] &quot;vector_layers_field_infos&quot;          &quot;vector_layers_statistics&quot;          
## [17] &quot;views_geometry_columns&quot;             &quot;views_geometry_columns_auth&quot;       
## [19] &quot;views_geometry_columns_field_infos&quot; &quot;views_geometry_columns_statistics&quot; 
## [21] &quot;virts_geometry_columns&quot;             &quot;virts_geometry_columns_auth&quot;       
## [23] &quot;virts_geometry_columns_field_infos&quot; &quot;virts_geometry_columns_statistics&quot;
</code></pre>
<p>Let’s try to select rows where the device id matches a given value
(e.g. 860), and the date time is between two given timestamps. For our
analysis, we only need <code>date_time</code>, <code>latitude</code>, <code>longitude</code> and
<code>altitude</code> so we will only select those.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">sqlTiming &lt;- <span style="color:#0a0">system.time</span>(data &lt;-  <span style="color:#0a0">dbGetQuery</span>(conn = db,
   <span style="color:#a50">&#34;SELECT date_time, latitude, longitude, altitude
</span><span style="color:#a50">    FROM processed_logs 
</span><span style="color:#a50">    WHERE device_info_serial = 860 
</span><span style="color:#a50">        AND date_time &lt; &#39;2014-07-01&#39; 
</span><span style="color:#a50">        AND date_time &gt; &#39;2014-03-01&#39;&#34;</span>
))

<span style="color:#0a0">print</span>(sqlTiming[3])
</code></pre></div><pre><code>## elapsed 
##  40.405
</code></pre>
<p>This provides a convenient and fast way to request subsets of data from
our large data file. We could do the same analysis for each of the
serial numbers, each time only loading that subset of the data. As an
example, consider the calculation of the average altitude over the
specified period for each of the bird serial identifiers in the list
<code>serial_id_list</code>. By using a for loop, the calculation is done for each
of the birds separately and the amount of data loaded into memory at the
same time is lower:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">serial_id_list &lt;- <span style="color:#0a0">c</span>(<span style="color:#099">853</span>, <span style="color:#099">860</span>, <span style="color:#099">783</span>)
<span style="color:#0a0">print</span>(<span style="color:#a50">&#34;Average altitude between 2014-03-01 and 2014-07-01:&#34;</span>)
</code></pre></div><pre><code>## [1] &quot;Average altitude between 2014-03-01 and 2014-07-01:&quot;
</code></pre>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#0a0">for </span>(serialid in serial_id_list) {
    data &lt;-  <span style="color:#0a0">dbGetQuery</span>(conn = db,
                       <span style="color:#0a0">sprintf</span>(<span style="color:#a50">&#34;SELECT date_time, latitude, longitude, altitude
</span><span style="color:#a50">                                FROM processed_logs 
</span><span style="color:#a50">                                WHERE device_info_serial = %d 
</span><span style="color:#a50">                                    AND date_time &lt; &#39;2014-07-01&#39; 
</span><span style="color:#a50">                                    AND date_time &gt; &#39;2014-03-01&#39;&#34;</span>, serialid))
    <span style="color:#0a0">print</span>(<span style="color:#0a0">sprintf</span>(<span style="color:#a50">&#34;serialID %d: %f&#34;</span>, serialid, <span style="color:#0a0">mean</span>(data$altitude)))
    }
</code></pre></div><pre><code>## [1] &quot;serialID 853: NA&quot;
## [1] &quot;serialID 860: 23.550518&quot;
## [1] &quot;serialID 783: 14.900030&quot;
</code></pre>
<p>Remark that we use the <code>sprintf</code> function to dynamically replace the
serial id in the sqlite query we will execute. For each loop, the <code>%d</code>
is replaced by the value of the serial id of the respective loop. Read
the
<a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/sprintf.html">manual</a>
of the <code>sprintf</code> function for more information and options.</p>
<h3 id="interacting-with-sqlite-databases-using-dplyr">Interacting with SQLite databases using <code>dplyr</code><a href="#interacting-with-sqlite-databases-using-dplyr" class="anchor"><svg height="22px" viewBox="0 0 24 24" width="22px"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a></h3>
<p>If you’re not comfortable with writing queries in SQL, R has a great
alternative: <code>dplyr</code>. <code>dplyr</code> can connect to a SQLite database and you
can perform the same operations on it that you would do on a dataframe.
However, dplyr will translate your commands to SQL, allowing you to take
advantage of the indexes in the SQLite database.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#0a0">library</span>(dplyr)
my_db &lt;- <span style="color:#0a0">src_sqlite</span>(db.name, create = <span style="color:#00a">FALSE</span>)
bird_tracking &lt;- <span style="color:#0a0">tbl</span>(my_db, <span style="color:#a50">&#34;processed_logs&#34;</span>)
results &lt;- bird_tracking %&gt;%
    <span style="color:#0a0">filter</span>(device_info_serial == <span style="color:#099">860</span>) %&gt;%
    <span style="color:#0a0">select</span>(date_time, latitude, longitude, altitude) %&gt;%
    <span style="color:#0a0">filter</span>(date_time &lt; <span style="color:#a50">&#34;2014-07-01&#34;</span>) %&gt;%
    <span style="color:#0a0">filter</span>(date_time &gt; <span style="color:#a50">&#34;2014-03-01&#34;</span>)
<span style="color:#0a0">head</span>(results)
</code></pre></div><pre><code>## # Source:   lazy query [?? x 4]
## # Database: sqlite 3.36.0
## #   [/Users/peter_desmet/Coding/Repositories/inbo/tutorials/content/tutorials/r_large_data_files_handling/2016-04-20-processed-logs-big-file-example.db]
##   date_time           latitude longitude altitude
##   &lt;chr&gt;                  &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1 2014-03-10 12:43:37     44.0     -7.59      626
## 2 2014-03-10 12:58:32     44.1     -7.67      405
## 3 2014-03-10 13:13:52     44.1     -7.69      326
## 4 2014-03-10 13:28:57     44.1     -7.71      250
## 5 2014-03-10 13:43:54     44.1     -7.72      174
## 6 2014-03-10 13:59:06     44.1     -7.73       23
</code></pre>
<p>Dplyr provides the ability to perform queries as above without the need
to know SQL. If you want to learn more about how to use <code>dplyr</code> with a
SQLite database, head over to <a href="https://cran.r-project.org/web/packages/dplyr/vignettes/databases.html">this
vignette</a>.</p>
<h3 id="create-a-sqlite-database-from-a-csv-file">Create a SQLite database from a CSV file<a href="#create-a-sqlite-database-from-a-csv-file" class="anchor"><svg height="22px" viewBox="0 0 24 24" width="22px"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"></path></svg></a></h3>
<p>In the case you have a CSV file available and you would like to query
the data using SQL queries or with <code>dplyr</code> as shown in the previous
sections, you can decide to convert the data to a SQlite database. The
conversion will require some time, but once available, it provides the
opportunity to query the data using SQL queries or with <code>dplyr</code> as shown
in the previous sections. Moreover, you can easily add additional tables
with related information to combine the data with.</p>
<p>If you already loaded the CSV file into memory, the creation of a SQLITE
database is very straighforward and can be achieved in two steps:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">db &lt;- <span style="color:#0a0">dbConnect</span>(<span style="color:#0a0">SQLite</span>(), dbname = <span style="color:#a50">&#34;example.sqlite&#34;</span>)
<span style="color:#0a0">dbWriteTable</span>(db, <span style="color:#a50">&#34;birdtracks&#34;</span>, allData)
<span style="color:#0a0">dbDisconnect</span>(db)
</code></pre></div><p>The first command creates a new database when the file <code>example.sqlite</code>
does not exist already. The command <code>dbWriteTable</code> writes the table in
the database. Hence, we can rerun the query from the previous section,
but now on the newly created SQlite database, with the single created
table <code>birdtracks</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">my_db &lt;- <span style="color:#0a0">src_sqlite</span>(<span style="color:#a50">&#34;example.sqlite&#34;</span>, create = <span style="color:#00a">FALSE</span>)
bird_tracking &lt;- <span style="color:#0a0">tbl</span>(my_db, <span style="color:#a50">&#34;birdtracks&#34;</span>)
results &lt;- bird_tracking %&gt;%
    <span style="color:#0a0">filter</span>(device_info_serial == <span style="color:#099">860</span>) %&gt;%
    <span style="color:#0a0">select</span>(date_time, latitude, longitude, altitude) %&gt;%
    <span style="color:#0a0">filter</span>(date_time &lt; <span style="color:#a50">&#34;2014-07-01&#34;</span>) %&gt;%
    <span style="color:#0a0">filter</span>(date_time &gt; <span style="color:#a50">&#34;2014-03-01&#34;</span>)
<span style="color:#0a0">head</span>(results)
</code></pre></div><pre><code>## # Source:   lazy query [?? x 4]
## # Database: sqlite 3.36.0
## #   [/Users/peter_desmet/Coding/Repositories/inbo/tutorials/content/tutorials/r_large_data_files_handling/example.sqlite]
## # … with 4 variables: date_time &lt;dbl&gt;, latitude &lt;dbl&gt;, longitude &lt;dbl&gt;,
## #   altitude &lt;int&gt;
</code></pre>
<p>However, when working with really large CSV files, you do not want to
load the entire file into memory first (this is the whole point of this
tutorial). An alternative strategy is to load the data from the CSV file
in chunks (small sections) and write them step by step to the SQlite
database.</p>
<p>This can be implemented by reading the CSV file in small sections (let’s
say 50000 lines each time) and move all sections to a given table in a
sqlite database. As this is a recurrent task, we will provide the
transformation in a custom written function, called <code>csv_to_sqlite</code>. The
function is available within the <a href="https://inbo.github.io/inborutils/"><code>inborutils</code>
package</a>. Check the function
documentation
<a href="https://inbo.github.io/inborutils/reference/csv_to_sqlite.html">online</a>
or by typing <code>?csv_to_sqlite</code> after installing and loading the
<code>inborutils</code> package. As SQlite does not natively support <code>date</code> and
<code>datetime</code> representations, the function converts those columns to an
appropriate string representation before copying the dates to sqlite. To
check for the date handling, the <code>lubridate</code> package is used.</p>
<p>As an example, let’s convert the processed bird logs csv file to a
sqlite database, called <code>example.sqlite</code> as a table <code>birdtracks</code>. Using
the default values for the preprocessing number of lines and the chunk
size, the conversion is as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#0a0">library</span>(inborutils)

sqlite_file &lt;- <span style="color:#a50">&#34;example2.sqlite&#34;</span>
table_name &lt;- <span style="color:#a50">&#34;birdtracks&#34;</span>

inborutils::<span style="color:#0a0">csv_to_sqlite</span>(csv_file = csv.name, 
              sqlite_file, table_name, pre_process_size = <span style="color:#099">1000</span>, 
              chunk_size = <span style="color:#099">50000</span>, show_progress_bar = <span style="color:#00a">FALSE</span>)
</code></pre></div><p>Hence, this approach will work for large files as well and is an ideal
first step when doing this kind of analysis. Once performed, the SQlite
database is available to query, similar to the previous examples:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">my_db &lt;- <span style="color:#0a0">src_sqlite</span>(<span style="color:#a50">&#34;example2.sqlite&#34;</span>, create = <span style="color:#00a">FALSE</span>)
</code></pre></div><pre><code>## Warning: `src_sqlite()` was deprecated in dplyr 1.0.0.
## Please use `tbl()` directly with a database connection
## This warning is displayed once every 8 hours.
## Call `lifecycle::last_lifecycle_warnings()` to see where this warning was generated.
</code></pre>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">bird_tracking &lt;- <span style="color:#0a0">tbl</span>(my_db, <span style="color:#a50">&#34;birdtracks&#34;</span>)
results &lt;- bird_tracking %&gt;%
    <span style="color:#0a0">filter</span>(device_info_serial == <span style="color:#099">860</span>) %&gt;%
    <span style="color:#0a0">select</span>(date_time, latitude, longitude, altitude) %&gt;%
    <span style="color:#0a0">filter</span>(date_time &lt; <span style="color:#a50">&#34;2014-07-01&#34;</span>) %&gt;%
    <span style="color:#0a0">filter</span>(date_time &gt; <span style="color:#a50">&#34;2014-03-01&#34;</span>)
<span style="color:#0a0">head</span>(results)
</code></pre></div><pre><code>## # Source:   lazy query [?? x 4]
## # Database: sqlite 3.36.0
## #   [/Users/peter_desmet/Coding/Repositories/inbo/tutorials/content/tutorials/r_large_data_files_handling/example2.sqlite]
##   date_time           latitude longitude altitude
##   &lt;chr&gt;                  &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1 2014-03-10 12:43:37     44.0     -7.59      626
## 2 2014-03-10 12:58:32     44.1     -7.67      405
## 3 2014-03-10 13:13:52     44.1     -7.69      326
## 4 2014-03-10 13:28:57     44.1     -7.71      250
## 5 2014-03-10 13:43:54     44.1     -7.72      174
## 6 2014-03-10 13:59:06     44.1     -7.73       23
</code></pre>
<p>Remark that the dates are properly handled, by making sure the date
representation inside SQlite is the converted string version.</p>
</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'><div class='categories'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M22,19a2,2,0,0,1-2,2H4a2,2,0,0,1-2-2V5A2,2,0,0,1,4,3H9l2,3h9a2,2,0,0,1,2,2Z"/>
  
</svg>
<span class='screen-reader-text'>Categories: </span><a class='category' href='/categories/r/'>r</a></div>
<div class='tags'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z"/>
  <line x1="7" y1="7" x2="7" y2="7"/>
  
</svg>
<span class='screen-reader-text'>Tags: </span><a class='tag' href='/tags/tidyverse/'>tidyverse</a>, <a class='tag' href='/tags/r/'>r</a>, <a class='tag' href='/tags/database/'>database</a></div>

  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/tutorials/r_database_access/'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 Previous</span>
        <span class='screen-reader-text'>Previous post: </span>Read data from INBO databases (SQL Server) with R</a>
    </div><div class='next-entry sep-before'>
      <a href='/tutorials/development_codecov/'>
        <span class='screen-reader-text'>Next post: </span>Code coverage<span aria-hidden='true'>Next <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="4" y1="12" x2="20" y2="12"/>
  <polyline points="14 6 20 12 14 18"/>
  
</svg>
</span>
      </a>
    </div></div>
</nav>




      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><div class='copyright'>
  <p><a href="http://creativecommons.org/licenses/by/4.0/"><img src="https://inbo.github.io/tutorials/images/cc-by.svg" alt="CC BY 4.0"></a> &copy; 2018-2025 Research Institute for Nature and Forest (INBO) </p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__assets_js_src="/assets/js/"</script>

<script src='/assets/js/main.c3bcf2df.js'></script><script src='/js/custom.js'></script>

</body>

</html>

