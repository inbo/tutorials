---
title: "INBO style guide for R code"
maintainer: "Thierry Onkelinx"
output: html_document
---

# Scope

This style guide applies to all R code where INBO is copyright holder. It is mandatory for all new projects intended to be distributed and highly recommended for all other projects. It doesn't apply for existing projects, except when revising such project. Then the style guide applies to the revised parts of the code.

# Recommended packages

## Data import

- `readr`: import text files
- `readexcel`: import Excel files
- `googlesheets`: import Google Sheets
- `DBI`: connect to databases PostgreSQL, SQLite, MySQL, Oracle, ...
- `RODBC`: connect to databases SQL Server, Access

## Data manipulation & transformation

- `dplyr`:
    - subsetting observations
    - subsetting variables
    - changing variables
    - aggregation
    - combining dataframes
- `tidyr`:
    - changing a dataframe from wide to long format and vice versa
    - nesting and unnesting dataframes
    - splitting a single variable into multiple variables

## Graphics

- `ggplot2`:all static graphics, charts and plots
- `INBOtheme`: INBO corporate identity for `ggplot2` graphics

## Quality control

- `lintr`: checking coding style
- `testthat`: writing unit tests
- `covr`: check which part of the code is not covered by unit tests

# Syntax

**RStudio hint**: _Tools > Global options > Code > Diagnotics_: Check everything

## General

- lines should not exceed 80 characters
    - split the command over multiple lines if the command is longer than 80 characters
    - **RStudio hint**: _Tools > Global options > Code > Display_: Check _Show margin_ and set _Margin column_ to 80
- object names should be meaningful
- object names should not exceed 20 characters
- object names should be lowercase
- use `_` to separate words in object names
    - function names with a single dot are allowed
- use single quotes (`'`) around characters and not double quotes (`"`)
- don't add commented code
    - use version control if you want to keep old versions of code

```{r eval = FALSE}
# Good
example_text <- example_function(
  first_argument = 'Some text', 
  second_argument = 'More text'
)

# Bad
some.really.long.dot.separated.name <- MyCoolFunction(FirstArgument = "Some text", second.argument = "More text")
```

## Whitespace

- don't use tabs, use two spaces instead
    - **RStudio hint**: _Tools > Global options > Code > Editing_: Check _Insert spaces for tab_ and set _Tab width_ to 2
- no space before a comma, one space after a comma
- one space before and after an infix operator (`+`, `-`, `*`, `/`, `^`, `&`, `|`, `%%`, `%/%`, `%*%`, `%in%`, ...)
- no spaces a the end of a line
    - **RStudio hint**: _Tools > Global options > Code > Saving_: Check _Strip trailing horizontal whitespace when saving_
- end the script file with a single blank line
    - **RStudio hint**: _Tools > Global options > Code > Saving_: Check _Ensure that source files end with newline_

## Assignments

- only create an object when you will use it later on
- always use `<-` for assignment
- use `=` only for passing arguments in a function
- one space before and one space after `<-` and `=`

```{r eval = FALSE}
# Good
x <- data.frame(z = 1:10)
summary(x)

# Bad
x=data.frame(z<-1:10)
```

## Brackets

R uses three types of brackets: round `(...)`, square `[...]` and curly `{...}`.

- no spaces after opening a bracket
- no spaces before closing a bracket
- no spaces before opening a bracket except:
    - one space with control flow functions (`if`, `else`, `for`, `while`)
- no spaces after closing a bracket except:
    - one space with control flow functions (`if`, `else`, `for`, `while`)
- `{` should not start on a newline and is always the end of a line
- apply indentation when splitting long text inside brackets over multiple lines

```{r eval = FALSE}
# Good
y <- seq(0, 2)
if (max(y) <= 10) {
  x <- 1
} else {
  x <- 2
}
sapply(
  y, 
  function(x){
    return(x)
  }
)

# Bad
y <- seq (0, 2   )
if(   max( y ) <= 10    )        
{ x <- 1 } else 
{ x <- 2 }
sapply( y , function ( x ) { return(x)})
```

## Special cases and exceptions

- selecting rows with square brackets `df[selection, ]`
    - this results in two conflicting rules
        1. a single space after a comma
        1. no space before a bracket
    - solution in case of a short command: add `# nolint` after the command
        - `df[selection, ] # nolint`
    - solution in case of a long command: split the command over several lines

```{r eval = FALSE}
# Good
relevant_subset <- original_dataframe[
  original_dataframe$x > some_value | original_dataframe$y < some_other_value, 
]
# Recommended dplyr alternative
relevant_subset <- original_dataframe %>%
  filter(x > some_value | y < some_other_value)

# Bad
relevant_subset <- original_dataframe[original_dataframe$x > some_value | original_dataframe$y < some_other_value, ] # nolint
```

- a really long text
    - text shorter than 80 characters but passed the 80 character limit due to the indentitation
        - solution: remove all indentation
    - text longer than 80 characters
        - solution: add `# nolint` at the end of the line
- functions from other packages with names that don't comply with this style guide
    - solution: add `# nolint` at the end of the line

**Important notice**

Adding `# nolint` at the end of a line excludes that line from the automatic checks for coding styles. Therefore use it only when you have no other options.

# Documentation

## Functions

- Add documentation above each function with `Roxygen` markup
- Add inline comments where relevant

## How-to's

- Add one or more how-to's to a package
- Add them as RMarkdown vignettes

# File structure

## R Package

### Functions

- all generic R functions should be distributed as an R package
- use `devtools::create()` to start a new pacakge
    - **RStudio hint**: _File > New project > New directory > R Package_: Type the name in _Package name_
- keep source files compact
    - create a separate file for each function, with tje file name equal to the function name. This makes it easy to find the correct source file.
    - exception: very short auxilary functions with related functionality
        - related functions can be bundled into one R script
        - file name is either equal to the most important function or describes the related functionality
- split large functions into several subfunctions

### Scripts

- place scripts in the `inst` folder
    - the scripts will be available for the user after installing the package
    - the location of the scripts can be found with `system.file("script-name.R", package = "yourpackage")`
    - use a relevant folder structure when adding lots of files to `inst`

### Unit tests

- use the `testthat` package for unit tests
    - use `devtools::use_testthat()` to setup the test infrastructure
- all unit tests are stored in `tests/testthat`
- all file should have either a `test_` or `helper_` prefix
    - files with `helper_` prefix contain auxiliary function for the tests but no tests
- the test files will be run in alphabetical order
    - setting the order of the files is easy by adding 3 letters to the prefix (eg. `test_aaa_`, `test_baa`, `test_zzz_`)
    - 3 letters offers quite some flexibility to insert new files at the correct location without having to rename at lot of files. If the first file is `test_aaa_` and the second `test_baa`, they you can 675 files between the two.
- unit test files can be larger than source files
- a unit test file can contain tests for several functions in case the functions are strongly related (e.g. subfunctions) and reuse test cases
- each package should contain the unit for coding style as listed below
    - store this in a file `tests/testthat/test_zzz_coding_style.R`
    - add this file to `.gitignore`
        - the coding style will be tested separatly when using continuous integration

```{r eval = FALSE}
if (requireNamespace("lintr", quietly = TRUE)) {
  context("lints")
  test_that("Package Style", {
    lintr::expect_lint_free()
  })
}
```

## R script

- group a long set of commands with similar functionality into a dedicated function
    - e.g. `prepare_data()`, `do_analysis()`, `create_figure()`, ...
- place the user defined functions in a separate file which you `source()` into the main script
    - it is better to use the same file structure as an R package
    - consider writing a simple package in case you have a lot of functions

## RMarkdown

- each chunk has only one output (figure, table, summary, ...)
- don't mix (heavy) calculations and output in the same chunk: this is more interesting for caching the results
- give chunks a relevant name: this make debugging easier and file name of figures and Bookdown label will be based on the chunk name
- avoid writing code that generates Markdown
    - use (parametrised) child documents instead
- use the bookdown version for long reports: this makes it easy to split a long report into several child documents
